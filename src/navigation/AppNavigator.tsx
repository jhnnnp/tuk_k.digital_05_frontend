import React, { useState, useEffect } from 'react';
import { View, Text, TouchableOpacity, Alert, Platform, ActivityIndicator } from 'react-native';
import Animated, {
    useSharedValue,
    useAnimatedStyle,
    withTiming,
    withSpring,
} from 'react-native-reanimated';
import { Ionicons } from '@expo/vector-icons';
import { useTheme } from '../styles/ThemeProvider';
import HomeScreen from '../pages/HomeScreen';
import LiveScreen from '../pages/LiveScreen';
import FullscreenVideoScreen from '../pages/FullscreenVideoScreen';
import RecordingsScreen from '../pages/RecordingsScreen';
import SettingsStackNavigator from './StackNavigator';
import Toast from 'react-native-toast-message';
import AsyncStorage from '@react-native-async-storage/async-storage';
import LoginScreen from '../pages/LoginScreen';
import SignupScreen from '../pages/SignupScreen';
import IntroScreen from '../pages/IntroScreen';
import AppLockScreen from '../pages/AppLockScreen';

export default function AppNavigator() {
    const { theme } = useTheme();
    const [activeTab, setActiveTab] = useState<'intro' | 'home' | 'live' | 'recordings' | 'settings' | 'login' | 'appLock' | 'fullscreen'>('intro');
    const [moveMode, setMoveMode] = useState(false); // Ïù¥ÎèôÎ™®Îìú ÏÉÅÌÉú Î¶¨ÌîÑÌåÖ
    const [showLiveView, setShowLiveView] = useState(false);
    const [showSignup, setShowSignup] = useState(false); // ÌöåÏõêÍ∞ÄÏûÖ ÌôîÎ©¥ ÏÉÅÌÉú
    const [showFindId, setShowFindId] = useState(false); // ÏïÑÏù¥Îîî Ï∞æÍ∏∞ ÌôîÎ©¥ ÏÉÅÌÉú
    const [showFindPassword, setShowFindPassword] = useState(false); // ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞ ÌôîÎ©¥ ÏÉÅÌÉú
    const [loading, setLoading] = useState(true); // Ï¥àÍ∏∞ Î°úÎî© ÏÉÅÌÉú
    const [showPinSetup, setShowPinSetup] = useState(false); // PIN ÏÑ§Ï†ï ÌôîÎ©¥ ÏÉÅÌÉú

    // ÌôîÎ©¥ Ï†ÑÌôò Ïï†ÎãàÎ©îÏù¥ÏÖò Í∞íÎì§
    const slideAnim = useSharedValue(0);
    const fadeAnim = useSharedValue(1);
    const scaleAnim = useSharedValue(1);

    useEffect(() => {
        const checkToken = async () => {
            setLoading(true);
            const token = await AsyncStorage.getItem('token');
            if (token) {
                // ÌÜ†ÌÅ∞Ïù¥ ÏûàÏúºÎ©¥ Î∞îÎ°ú ÌôàÏúºÎ°ú, ÏóÜÏúºÎ©¥ Ïù∏Ìä∏Î°úÎ°ú
                setActiveTab('home');
            } else {
                // ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏúºÎ©¥ Ïù∏Ìä∏Î°ú Ïä§ÌÅ¨Î¶∞Î∂ÄÌÑ∞ ÏãúÏûë
                setActiveTab('intro');
            }
            setLoading(false);
        };
        checkToken();
    }, []);

    // Ïù¥ÎèôÎ™®Îìú Ìï¥Ï†ú UX Î™®Îìú: 'confirm' | 'auto'
    const moveModeExitUX: 'confirm' | 'auto' = 'confirm'; // 'auto'Î°ú Î∞îÍæ∏Î©¥ ÏûêÎèô OFF+Toast

    // Ïù¥ÎèôÎ™®Îìú Ìï¥Ï†ú Î∞è ÌÉ≠ Ïù¥Îèô Ï≤òÎ¶¨
    const handleNavigateAway = (targetTab: string) => {
        if (moveMode) {
            if (moveModeExitUX === 'confirm') {
                Alert.alert(
                    'Ïù¥ÎèôÎ™®Îìú Ìï¥Ï†ú',
                    'Ïù¥ÎèôÎ™®ÎìúÎ•º Ï∑®ÏÜåÌï†ÍπåÏöî?',
                    [
                        { text: 'ÏïÑÎãàÏò§', style: 'cancel' },
                        {
                            text: 'Ïòà',
                            onPress: () => {
                                setMoveMode(false);
                                setActiveTab(targetTab as 'home' | 'live' | 'recordings' | 'settings');
                            }
                        }
                    ]
                );
            } else if (moveModeExitUX === 'auto') {
                setMoveMode(false);
                Toast.show({
                    type: 'info',
                    text1: 'Ïù¥ÎèôÎ™®ÎìúÍ∞Ä Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.'
                });
                setActiveTab(targetTab as 'home' | 'live' | 'recordings' | 'settings');
            }
        } else {
            setActiveTab(targetTab as 'home' | 'live' | 'recordings' | 'settings');
        }
    };

    // Ïï†ÎãàÎ©îÏù¥ÏÖò Ïä§ÌÉÄÏùº
    const slideAnimatedStyle = useAnimatedStyle(() => ({
        transform: [{ translateX: slideAnim.value }],
        opacity: fadeAnim.value,
    }));

    const scaleAnimatedStyle = useAnimatedStyle(() => ({
        transform: [{ scale: scaleAnim.value }],
    }));

    // ÌôîÎ©¥ Ï†ÑÌôò Ïï†ÎãàÎ©îÏù¥ÏÖò Ìï®Ïàò
    const animateScreenTransition = (direction: 'in' | 'out', callback: () => void) => {
        const slideDistance = direction === 'in' ? 300 : -300;

        if (direction === 'out') {
            // ÌòÑÏû¨ ÌôîÎ©¥ÏùÑ Î∞ñÏúºÎ°ú Ïä¨ÎùºÏù¥Îìú
            slideAnim.value = withTiming(slideDistance, { duration: 300 });
            fadeAnim.value = withTiming(0, { duration: 200 });

            setTimeout(() => {
                callback();
                // ÏÉà ÌôîÎ©¥ÏùÑ Î∞òÎåÄ Î∞©Ìñ•ÏóêÏÑú ÏãúÏûë
                slideAnim.value = -slideDistance;
                fadeAnim.value = 0;

                // ÏÉà ÌôîÎ©¥ÏùÑ Ï§ëÏïôÏúºÎ°ú Ïä¨ÎùºÏù¥Îìú
                slideAnim.value = withTiming(0, { duration: 300 });
                fadeAnim.value = withTiming(1, { duration: 200 });
            }, 200);
        } else {
            // ÏÉà ÌôîÎ©¥ÏùÑ Ï§ëÏïôÏúºÎ°ú Ïä¨ÎùºÏù¥Îìú
            slideAnim.value = withTiming(0, { duration: 300 });
            fadeAnim.value = withTiming(1, { duration: 200 });
            callback();
        }
    };

    const handleLogout = async () => {
        await AsyncStorage.removeItem('token');
        setActiveTab('login');
    };

    const tabs = [
        { id: 'home', icon: 'home', label: 'Ìôà' },
        { id: 'live', icon: 'videocam', label: 'Ïã§ÏãúÍ∞Ñ' },
        { id: 'recordings', icon: 'play-circle', label: 'ÎÖπÌôî' },
        { id: 'settings', icon: 'settings', label: 'ÏÑ§Ï†ï' },
    ];

    const renderScreen = () => {
        if (loading) {
            return (
                <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: theme.background }}>
                    <ActivityIndicator size="large" color={theme.primary} />
                </View>
            );
        }
        if (showLiveView) {
            return <LiveScreen onBack={() => setShowLiveView(false)} moveMode={moveMode} setMoveMode={setMoveMode} />;
        }
        if (showSignup) {
            return (
                <Animated.View style={[{ flex: 1 }, slideAnimatedStyle]}>
                    <SignupScreen
                        onSignupSuccess={() => {
                            animateScreenTransition('out', () => {
                                setShowSignup(false);
                                setActiveTab('home');
                            });
                        }}
                        onBackToLogin={() => {
                            animateScreenTransition('out', () => {
                                setShowSignup(false);
                                // Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞à Îïå Í∞ïÏ†úÎ°ú Î¶¨Î†åÎçîÎßÅ
                                setTimeout(() => {
                                    setActiveTab('login');
                                    console.log('üîÑ [NAVIGATION] ÌöåÏõêÍ∞ÄÏûÖ ‚Üí Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ Ï†ÑÌôò');
                                }, 100);
                            });
                        }}
                    />
                </Animated.View>
            );
        }
        switch (activeTab) {
            case 'intro':
                return (
                    <IntroScreen
                        onAnimationComplete={() => {
                            // Ïù∏Ìä∏Î°ú ÏôÑÎ£å ÌõÑ Î∂ÄÎìúÎü¨Ïö¥ Ï†ÑÌôòÏùÑ ÏúÑÌï¥ ÏßÄÏó∞
                            setTimeout(() => {
                                setActiveTab('login');
                            }, 300);
                        }}
                    />
                );
            case 'home':
                return <HomeScreen />;
            case 'live':
                return <LiveScreen onBack={() => setActiveTab('home')} moveMode={moveMode} setMoveMode={setMoveMode} onFullscreen={() => setActiveTab('fullscreen')} />;
            case 'fullscreen':
                return <FullscreenVideoScreen navigation={{ goBack: () => setActiveTab('live') }} />;
            case 'recordings':
                return <RecordingsScreen />;
            case 'settings':
                return <SettingsStackNavigator onLogout={handleLogout} onPinSetupShow={() => setShowPinSetup(true)} onPinSetupHide={() => setShowPinSetup(false)} />;
            case 'appLock':
                return <AppLockScreen navigation={{ goBack: () => setActiveTab('settings') }} />;
            case 'login':
                return (
                    <Animated.View style={[{ flex: 1 }, slideAnimatedStyle]}>
                        <LoginScreen
                            onLoginSuccess={() => {
                                console.log('üéâ [NAVIGATION] Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ - Settings ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô');
                                setActiveTab('settings');
                            }}
                            onSignup={() => {
                                animateScreenTransition('out', () => setShowSignup(true));
                            }}
                            onFindId={() => {
                                // FindIdScreen ÎåÄÏã† Î°úÍ∑∏Ïù∏ ÌôîÎ©¥Ïùò Î™®Îã¨Î°ú ÎåÄÏ≤¥
                                setShowFindId(true);
                            }}
                            onFindPassword={() => {
                                // FindPasswordScreen ÎåÄÏã† Î°úÍ∑∏Ïù∏ ÌôîÎ©¥Ïùò Î™®Îã¨Î°ú ÎåÄÏ≤¥
                                setShowFindPassword(true);
                            }}
                        />
                    </Animated.View>
                );
            default:
                return <HomeScreen />;
        }
    };

    // Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ/Ïù∏Ìä∏Î°úÏóêÏÑúÎäî ÌïòÎã®ÌÉ≠ Ïà®ÍπÄ
    const hideTabs = activeTab === 'login' || activeTab === 'intro' || showSignup || showFindId || showFindPassword || activeTab === 'appLock' || showPinSetup || activeTab === 'fullscreen';

    return (
        <View style={{ flex: 1, backgroundColor: theme.background }}>
            {/* Main Content */}
            <View style={{ flex: 1 }}>
                {renderScreen()}

                {/* ÏïÑÏù¥Îîî Ï∞æÍ∏∞ ÌôîÎ©¥ */}
                {showFindId && (
                    <Animated.View style={[{ flex: 1, position: 'absolute', top: 0, left: 0, right: 0, bottom: 0 }, slideAnimatedStyle]}>
                        {/* FindIdScreen ÎåÄÏã† Î°úÍ∑∏Ïù∏ ÌôîÎ©¥Ïùò Î™®Îã¨Î°ú ÎåÄÏ≤¥ */}
                        <LoginScreen
                            onBack={() => {
                                setShowFindId(false);
                            }}
                            isFindIdModal={true} // Î™®Îã¨ ÌÉÄÏûÖ ÏãùÎ≥Ñ
                        />
                    </Animated.View>
                )}

                {/* ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞ ÌôîÎ©¥ */}
                {showFindPassword && (
                    <Animated.View style={[{ flex: 1, position: 'absolute', top: 0, left: 0, right: 0, bottom: 0 }, slideAnimatedStyle]}>
                        {/* FindPasswordScreen ÎåÄÏã† Î°úÍ∑∏Ïù∏ ÌôîÎ©¥Ïùò Î™®Îã¨Î°ú ÎåÄÏ≤¥ */}
                        <LoginScreen
                            onBack={() => {
                                setShowFindPassword(false);
                            }}
                            isFindPasswordModal={true} // Î™®Îã¨ ÌÉÄÏûÖ ÏãùÎ≥Ñ
                        />
                    </Animated.View>
                )}
            </View>

            {/* Bottom Navigation: Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ/Ïù∏Ìä∏Î°úÏóêÏÑúÎäî Ïà®ÍπÄ */}
            {!hideTabs && (
                <View style={{
                    backgroundColor: theme.surface,
                    borderTopWidth: 1,
                    borderTopColor: theme.outline,
                    paddingBottom: 20,
                    paddingTop: 8
                }}>
                    <View style={{
                        flexDirection: 'row',
                        justifyContent: 'space-around',
                        paddingHorizontal: 16
                    }}>
                        {tabs.map((tab) => {
                            const isActive = activeTab === tab.id;
                            return (
                                <TouchableOpacity
                                    key={tab.id}
                                    onPress={() => {
                                        if (activeTab === 'live' && tab.id !== 'live') {
                                            handleNavigateAway(tab.id);
                                        } else {
                                            setActiveTab(tab.id as 'home' | 'live' | 'recordings' | 'settings');
                                        }
                                    }}
                                    style={{
                                        alignItems: 'center',
                                        paddingVertical: 8,
                                        paddingHorizontal: 12,
                                        borderRadius: 12
                                    }}
                                >
                                    <View style={{
                                        alignItems: 'center',
                                        gap: 4
                                    }}>
                                        <Ionicons
                                            name={tab.icon as any}
                                            size={24}
                                            color={isActive ? theme.primary : theme.textSecondary}
                                            style={{
                                                transform: [{ scale: isActive ? 1.1 : 1 }]
                                            }}
                                        />
                                        <Text style={{
                                            fontFamily: isActive ? 'GoogleSans-Medium' : 'GoogleSans-Regular',
                                            fontSize: 10,
                                            color: isActive ? theme.primary : theme.textSecondary
                                        }}>
                                            {tab.label}
                                        </Text>
                                    </View>
                                </TouchableOpacity>
                            );
                        })}
                    </View>
                </View>
            )
            }
            <Toast />
        </View >
    );
} 